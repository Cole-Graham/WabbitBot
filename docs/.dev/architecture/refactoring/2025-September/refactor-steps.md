# WabbitBot Architecture Refactor Implementation Steps

## Clarifications and Decisions (2025-09)
- **DbContext generation ownership**: `WabbitBotDbContext` is fully generated by the source generator. The
  generated file intentionally is not `partial`. A small hand-written `partial` stub exists only to provide
  a stable symbol for the IDE/compiler.
- **PostgreSQL only**: The project targets PostgreSQL via Npgsql exclusively. Remove remaining SQLite fields
  and logic (e.g., in `DatabaseSettings`) and any related configuration/doc references.
- **Entity metadata strategy (Option A)**: Entity classes are the single source of truth using
  `[EntityMetadata]`. Do not maintain `.DbConfig.cs` manually; align all docs and plans to Option A.
- **Event system status**: Core bus refactor is complete. A final pass is required to define the event
  catalogue, conventions, and to retire legacy events that embed old assumptions.

 

## Step 1: Entity Redefinition for Native PostgreSQL JSON Support ‚úÖ COMPLETE
1a. Entity Redefinition for Native PostgreSQL JSON Support
1b. Remove Manual JSON Properties
1c. Use Native Complex Objects
1d. Leverage PostgreSQL JSONB Features
1e. Npgsql Automatic Mapping

## Step 2: EF Core Foundation ‚úÖ COMPLETE
2a. Add Npgsql.EntityFrameworkCore.PostgreSQL Package
2b. Create WabbitBotDbContext with JSONB Configurations
2c. Configure Entity Mappings for JSONB Columns
2d. Set up Connection String Management

## Step 3: Database Layer Refinement ‚úÖ COMPLETE
3a. Implement `DatabaseService<TEntity>` with partial classes for Repository, Cache, and Archive
3b. Consolidate logic from `RepositoryService`, `CacheService`, and `ArchiveService` into `DatabaseService` partials
3c. Remove old `RepositoryService`, `CacheService`, and `ArchiveService` classes
3d. Remove MapEntity/BuildParameters Methods from Component Classes
3e. Implement Entity Configuration Pattern

## Step 4: Schema Migration ‚úÖ COMPLETE
4a. Implement Database Versioning Strategy
4b. Handle Schema Migration Scripts
4c. Add JSONB Indexes for Performance Optimization
4d. Update Table Structures for Native JSON Support
4e. Migrate Existing Data (if any)

## Step 5: Additional Entity Integration ‚úÖ COMPLETE
5a. Integrate Stats Entity (Remove IJsonVersioned, Inherit from Entity)
5b. Integrate SeasonConfig Entity (Runtime Season Configuration)
5c. Integrate SeasonGroup Entity (Season Grouping)
5d. Integrate LeaderboardItem Entity (Extract from Leaderboard)
5e. Handle IJsonVersioned Interface Removal

## Step 5.5: Re-evaluate ListWrapper Classes in PostgreSQL/EF Core Architecture ‚úÖ COMPLETE
5.5a. Critical Analysis: Evaluate if ListWrapper classes make sense in PostgreSQL/EF Core architecture
5.5b. Decision: ELIMINATE ListWrapper classes - they add unnecessary complexity
5.5c. Move Business Logic: Transfer valuable logic to CoreService
5.5d. Add Strategic Caching: Implement caching directly in CoreService where needed
5.5e. Update Dependencies: Remove all references to ListWrapper classes
5.5f. Delete Classes: Remove ListWrapper classes and interfaces entirely

## Step 6: JSONB Schema Migration ‚úÖ COMPLETE
6a. Implement EF Core Migrations Strategy (no production data concerns)
6b. Update Database Schema to Use JSONB Columns
6c. Add JSONB Indexes for Performance Optimization
6d. Update Table Structures for Native JSON Support
6e. Migration Strategy Documented (./database-migration-strategy.md)

## Step 6.1: Entity Relationship Type Correction ‚úÖ COMPLETED
6.1a. Analyze Current String Reference Usage
6.1b. Update Entity Class Properties
6.1c. Update Database Migration Scripts
6.1d. Update EF Core Configurations
6.1e. Implement Data Migration Strategy
6.1f. Update Business Logic Code
6.1g. Update LINQ Queries
6.1h. Move Entity Definitions to Common Directory

## Step 6.2: Code Organization and Cleanup ‚úÖ COMPLETED
6.2a. Reorganize ConfigureIndexes Method Regions
6.2b. Reorganize EntityConfigurations.cs by Entity Groups
6.2c. Reorganize EntityConfigTests.cs to Match New Structure

## Step 6.3: Simplify Map Entity and Refactor Thumbnail Management ‚úÖ COMPLETED
6.3a. Simplify Map Entity
6.3b. Create ThumbnailUtility in WabbitBot.Common
6.3c. Update Configuration for Thumbnail Management
6.3d. Update Usage in Application Services
6.3e. Update Tests

## Step 6.4: Unified DatabaseService Architecture ‚úÖ COMPLETED
6.4a. Create DatabaseService Structure with Partial Classes ‚úÖ COMPLETED
6.4b. Implement Repository Operations (DatabaseService.Repository.cs) ‚úÖ COMPLETED
6.4c. Implement Cache Operations (DatabaseService.Cache.cs) ‚úÖ COMPLETED
6.4d. Implement Archive Operations (DatabaseService.Archive.cs) ‚úÖ COMPLETED
6.4e. Update CoreService Integration ‚úÖ COMPLETED
6.4f. Migrate Entities to DatabaseService ‚è≥ PENDING (boilerplate left as-is)
6.4g. Update CoreService.Database.cs to consume generated EntityConfig metadata/accessors ‚è≥ PENDING
6.4h. DbServiceFactory removed as redundant ‚Äî do not reintroduce; rely on generated accessors and CoreService integration ‚úÖ CONFIRMED
6.4i. Clean Up Old Services ‚úÖ COMPLETED

## Step 6.5: Legacy Closure and Gap Remediation ‚è≥ IN PROGRESS
6.5a. Implement unified `ErrorService` architecture ‚Äî ‚úÖ DONE
  - Common already contains `IErrorService`, `ErrorContext`, and partials (`ErrorService.Logging/Notification/Recovery`).
  - Layering decision: keep Global/Core/DiscBot handlers as thin facades that enrich `ErrorContext` and delegate to the unified `IErrorService` (no duplicate logic in project-level handlers).
  - Core: replaced ad-hoc logging in `SeasonHandler`, `ConfigurationService`, `ConfigurationHandler`, `ConfigurationCommands`, and `LeaderboardCore` with `ErrorService` calls. Startup routes critical failures via `GlobalErrorHandler`.
  - DiscBot: added thin facade to log via `IErrorService` while publishing Discord error events.
  - Follow-up: optional throttling/escalation policies.
6.5b. Finish Step 6.4f by migrating active features to `DatabaseService<T>` ‚Äî ‚úÖ DONE
  - Deep sweep confirms feature code uses `DatabaseService<T>`/`CoreService.{Entity}` only. Remaining direct EF usage is constrained to infra (`EfRepositoryAdapter`, `EfArchiveProvider`, `DbContextFactory/Provider`, `SchemaVersionTracker`) and tests scaffolding.
6.5c. Replace lingering runtime DI or event bus hooks that point at legacy assemblies ‚Äî ‚úÖ DONE (no DI; event buses aligned)
6.5d. Refresh tests to match the refactored paths and remove suites tied to deprecated code ‚Äî ‚è≥ IN PROGRESS
  - Generator/db integration building; add CoreService CRUD tests and error-path tests.
6.5e. Remove manual EF configuration and any `.DbConfig.cs` remnants (Option A) ‚Äî ‚úÖ DONE
6.5f. Remove SQLite-related code/paths; clean `src/deprecated` where replacements exist ‚Äî ‚è≥ IN PROGRESS
  - Continue purging SQLite references in docs/config/scripts as encountered.

## Step 6.6: Application & Database Versioning Strategy ‚úÖ COMPLETE
> **üìã COMPLETED 2025-09-30:** Full versioning infrastructure implemented. Bonus: Fixed critical Step 6.5 bug, removed IDbContextFactory abstraction, and established clean infrastructure pattern.
6.6a. Create Application Version Tracking (ApplicationInfo Class) ‚Äî ‚úÖ DONE
6.6b. Implement Schema Version Tracking (SchemaVersionTracker Class) ‚Äî ‚úÖ DONE
6.6c. Add Version Compatibility Checking on Startup ‚Äî ‚úÖ DONE
6.6d. Create Feature Flags System (FeatureManager for Gradual Rollouts) ‚Äî ‚úÖ DONE
6.6e. Implement Version Metadata Table (Schema_Metadata for Audit Trail) ‚Äî ‚úÖ DONE
6.6f. Add Version Drift Monitoring (Alerting for Incompatible Combinations) ‚Äî ‚úÖ DONE
6.6g. Create Compatibility Test Suite (VersionCompatibilityTests) ‚Äî ‚úÖ DONE
6.6h. Update Migration Templates (Version Metadata Integration) ‚Äî ‚úÖ DONE

**Implementation Complete:**
- ‚úÖ VersionMonitor background service for drift monitoring (30-minute intervals)
- ‚úÖ SchemaMetadata infrastructure entity (manual EF config, no Entity inheritance, no source generation)
- ‚úÖ Comprehensive test suite (23 passing tests)
- ‚úÖ Migration template best practices documentation ([migration-template-guide.md](./migration-template-guide.md))
- ‚úÖ WabbitBotDbContext.Manual.cs partial class for infrastructure entities
- ‚úÖ DbContextGenerator emits `partial` keyword for extensibility

**Architectural Pattern Established:**
- ‚úÖ Infrastructure entities (SchemaMetadata) use manual configuration
- ‚úÖ Business entities (Player, Team, etc.) use source generation
- ‚úÖ Clear separation: infrastructure in `WabbitBot.Core.Common.Models`, domains in `Models/{Domain}`
- ‚úÖ No DatabaseService/Cache/Archive for audit tables (append-only, direct EF queries)

**Bonus Fixes (Same Session):**
- ‚úÖ Fixed incomplete Step 6.5 refactoring (removed dead DI initialization code from 6.4)
- ‚úÖ Removed `IDbContextFactory` abstraction (architectural simplification)
- ‚úÖ All database access now uses `WabbitBotDbContextProvider` consistently

## Step 6.7: Source Generators ‚úÖ COMPLETED
6.7a. DbContext generator: generate foreign key relationships ‚úÖ
6.7b. Finalize index generation (including JSONB GIN indexes) ‚úÖ
6.7c. Maintain ownership model: generator owns `WabbitBotDbContext`; keep minimal manual `partial` stub ‚úÖ
6.7d. Ensure 100% entity coverage with `[EntityMetadata]` across all domains ‚úÖ

## Step 6.8: Tests and Validation ‚è≥ IN PROGRESS
6.8a. Add generator snapshot tests (SourceGenerators.Tests) ‚Äî ‚úÖ DONE (smoke placeholder added; expansion optional)
6.8b. Add analyzer tests (Analyzers.Tests) ‚Äî ‚úÖ DONE (WB001/WB002/WB004 exercised with Roslyn harness)
6.8c. Add DbContext integration tests (CRUD + JSONB) and performance baselines ‚Äî ‚è≥ IN PROGRESS (CRUD+JSONB done; perf pending)
  - Note: Proper EF/Npgsql validation requires a real PostgreSQL instance. Use Testcontainers (preferred) or docker-compose
    to spin up `postgres:16` in test setup; run EnsureCreated/migrations, execute tests, then dispose. InMemory/SQLite are
    insufficient for JSONB and GIN behaviors; unit tests should remain lightweight without asserting provider-specific behavior.
6.8d. Add event integration tests: cross-bus forwarding and req/resp correlation with timeouts ‚Äî ‚úÖ DONE

## Step 6.9: Refactor DatabaseService Foundation (Common) ‚úÖ COMPLETED
6.9a. Introduce IRepositoryAdapter<TEntity> in Common; no EF/Npgsql types ‚Äî ‚úÖ DONE
6.9b. Implement EfRepositoryAdapter<TEntity> in Core using WabbitBotDbContext and wire provider at startup via CoreService.InitializeServices ‚Äî ‚úÖ DONE
6.9c. Refactor DatabaseService.Repository to call adapter; remove raw SQL ‚Äî ‚úÖ DONE
6.9d. Make caching optional via ICacheProvider<TEntity> (NoOp + InMemory LRU) ‚Äî ‚úÖ DONE
6.9e. Remove QueryAsync from IDatabaseService; use CoreService.WithDbContext for complex queries ‚Äî ‚úÖ DONE
6.9f. Error handling and results: keep Result API; map adapter exceptions to sanitized failures ‚Äî ‚úÖ DONE
6.9g. Archive design: per-entity `{table}_archive` with metadata, history/restore helpers, retention policy ‚Äî ‚úÖ DONE (write path + retention; history/restore pending in 6.8 tests scope)
6.9h. Generator support: emit `EArchive`, DbSet/config/indexes, mapper, provider partials, and partial hooks; add attribute-driven archive options ‚Äî ‚úÖ DONE (mappers emitted; provider registrations via EmitArchiveRegistration; attribute options for cache/archive)
6.9i. Generator support for cache registration: manual stub `CoreService.RegisterCacheProviders()` exists; extend generator to optionally emit per-entity registrations when `[EntityMetadata(EmitCacheRegistration = true)]` ‚Äî ‚úÖ DONE

6.9j. Generator follow-ups (relationship/config parity with EF/Npgsql) ‚Äî ‚úÖ DONE
  - Emitted EF relationship mappings for collection navigations (e.g., `Game.StateHistory` as `HasMany(...).WithOne(...).HasForeignKey(...).OnDelete(Cascade)`).
  - Removed `.Property(...)` for navigation collections; retained for scalar collections only.
  - Emitted Postgres-specific column types: `uuid[]`, `text[]`, and `jsonb` for dictionaries/lists.
  - Startup builds Npgsql data source with `EnableDynamicJson()` and uses it via `UseNpgsql(dataSource)`.
  - Validation: Postgres Testcontainers test using generated `WabbitBotDbContext` passes for `Game` with two `GameStateSnapshot` records (includes `Include(g => g.StateHistory)` JSONB round-trip).


## Step 7: CoreService Organization ‚úÖ COMPLETE
> **üìã CURRENT DESIGN:** Entity.cs (data model) + EntityCore.cs (business logic) is the established pattern. CoreService provides infrastructure orchestration, not entity business logic.

7a. Create Main `CoreService.cs` for infrastructure orchestration ‚Äî ‚úÖ DONE
7b. Utilize `DatabaseService<TEntity>` for all data access (via generated accessors) ‚Äî ‚úÖ DONE
7c. Utilize `ErrorService` for all error handling ‚Äî ‚úÖ DONE
7d. ~~Organize `CoreService` with partial classes for different domains~~ ‚Äî ‚ùå OUTDATED
   - **Current Design:** Business logic lives in `[Entity]Core.cs` files (MatchCore.cs, PlayerCore.cs, etc.)
   - **CoreService Role:** Infrastructure (DatabaseService accessors, ErrorService, EventBus, DbContext helpers)
7e. Set up Direct Instantiation and Event Messaging (No Runtime DI) ‚Äî ‚úÖ DONE

**Architecture Established:**
- ‚úÖ `CoreService.cs` - Static partial class with infrastructure (EventBus, ErrorHandler, utility methods)
- ‚úÖ `CoreService.Database.cs` - DbContext helpers (`WithDbContext`, `TryWithDbContext`, etc.)
- ‚úÖ `DatabaseServiceAccessors.g.cs` - Generated accessors (`CoreService.Players`, `CoreService.Teams`, etc.)
- ‚úÖ `[Entity]Core.cs` files - Business logic, factory methods, validation (MatchCore, PlayerCore, TeamCore, etc.)
- ‚úÖ No runtime DI - static providers and direct instantiation

## Step 8: Entity Migration ‚ùå OBSOLETE (Design Changed)
> **üìã SUPERSEDED:** This step was based on migrating business logic to CoreService partials. The actual design uses the Entity + EntityCore pattern instead.

~~8a. Migration Strategy: Move all entity-specific business logic into `CoreService` partials~~
~~8b. Foundation Phase~~
~~8c. CoreService Structure Phase~~
~~8d. Entity Migration Phase~~
~~8e. Testing & Cleanup Phase~~

**Current Pattern (Implemented):**
- ‚úÖ Business logic resides in `[Entity]Core.cs` files (e.g., `MatchCore.cs`, `PlayerCore.cs`, `TeamCore.cs`)
- ‚úÖ EntityCore files contain factory methods, business operations, validation
- ‚úÖ CoreService provides infrastructure via generated `DatabaseService<TEntity>` accessors
- ‚úÖ Usage: `await CoreService.Players.GetByIdAsync(id)` for CRUD, EntityCore for business logic

## Step 9: Configuration and PostgreSQL Setup ‚úÖ COMPLETE
> **üìã COMPLETED:** PostgreSQL-only configuration with Npgsql, JSONB, GIN indexes, and EF Core migrations fully implemented.

9a. PostgreSQL JSON Strategy - Use Npgsql Library ‚Äî ‚úÖ DONE
   - ‚úÖ NpgsqlDataSource with `EnableDynamicJson()` in `WabbitBotDbContextProvider`
   - ‚úÖ JSONB columns for dictionaries, lists, and complex objects
   - ‚úÖ Native LINQ support for JSON queries
9b. Configuration Management ‚Äî ‚úÖ DONE
   - ‚úÖ `appsettings.json` with PostgreSQL connection strings
   - ‚úÖ `DatabaseSettings` class for validation
   - ‚úÖ Environment-specific config files (Development, Production)
9c. Database Schema Changes (Generated) ‚Äî ‚úÖ DONE
   - ‚úÖ EF Core migrations for schema management
   - ‚úÖ UUID primary keys (gen_random_uuid())
   - ‚úÖ JSONB columns for complex data
9d. Unified Table Structure ‚Äî ‚úÖ DONE
   - ‚úÖ All entities follow consistent pattern (UUID PK, created_at, updated_at, etc.)
   - ‚úÖ Archive tables with `{table}_archive` naming
   - ‚úÖ Snake_case column naming for PostgreSQL conventions
9e. Indexing Strategy ‚Äî ‚úÖ DONE
   - ‚úÖ GIN indexes for JSONB columns (generated)
   - ‚úÖ Standard indexes on common query fields
   - ‚úÖ Foreign key indexes for navigation properties

## FINALIZATION/REFINEMENT: Testing & Cleanup
- **Final Validation and Architecture Cleanup** - Comprehensive testing and cleanup to ensure production readiness
- **a. VersionCompatibilityTests** ‚úÖ DONE - Version compatibility test suite complete (Step 6.6)
- **b. Comprehensive Integration Testing** ‚è≥ IN PROGRESS - DatabaseService CRUD + JSONB tests done; end-to-end workflow tests pending
- **c. Performance Benchmarking** ‚è≥ PENDING - Establish baselines for query performance, cache efficiency, JSONB operations
- **d. Production Readiness Validation** ‚è≥ PENDING - Final deployment checklist and environment verification
- **e. Documentation Finalization** ‚è≥ IN PROGRESS - Refactoring logs complete; user guides and API docs pending
- **f. Documentation Alignment** ‚è≥ IN PROGRESS - Migration guide done; "Add an Entity" guide and CoreService usage guide pending

### Testing Strategy
- **Unit Tests**: 
  - DatabaseService operations via `CoreService.{Entity}` static accessors
  - EntityCore business logic (factory methods, validation, state transitions)
  - Repository adapter implementations
  - Cache provider behavior (NoOp, InMemory LRU)
- **Integration Tests**: 
  - Full entity lifecycle (create via EntityCore ‚Üí persist via DatabaseService ‚Üí update ‚Üí archive)
  - PostgreSQL JSONB operations (uuid[], text[], jsonb columns with GIN indexes)
  - Navigation property queries via `CoreService.WithDbContext()`
  - Event bus integration (Core ‚Üí Global forwarding, request-response correlation)
- **Performance Tests**: 
  - Cache hit vs miss performance
  - JSONB containment query performance (with/without GIN indexes)
  - Complex queries with Include/navigation properties
  - Bulk operation throughput

### Cleanup Checklist
- **Deprecated Code**:
  - ‚úÖ ListWrapper classes removed (Step 5.5)
  - ‚úÖ IJsonVersioned interface removed
  - ‚úÖ Individual entity services never created (jumped to DatabaseService pattern)
  - ‚è≥ Clean up `src/deprecated/` directory
  - ‚è≥ Remove SQLite references in docs/config
- **Configuration**:
  - ‚úÖ PostgreSQL connection strings (Step 9)
  - ‚úÖ Static CoreService initialization (Step 7)
  - ‚úÖ No runtime DI architecture
  - ‚úÖ Event bus integration (Steps 6.5, 6.8)
  - ‚è≥ Verify startup initialization order
- **Documentation**:
  - ‚úÖ Refactoring logs for Steps 1-9 complete
  - ‚úÖ Migration template guide (Step 6.6)
  - ‚è≥ "Add an Entity" guide (Entity + EntityCore + [EntityMetadata] pattern)
  - ‚è≥ CoreService usage guide (static accessors + WithDbContext)
  - ‚è≥ Performance guide (JSONB + GIN indexes + caching)
  - ‚è≥ Update README with current architecture

### Final Validation
- **Architecture Verification**:
  - ‚úÖ Static CoreService with generated DatabaseService accessors (`CoreService.Players`, `CoreService.Teams`, etc.)
  - ‚úÖ DatabaseService<TEntity> provider-agnostic layer (Repository, Cache, Archive adapters)
  - ‚úÖ EntityCore pattern for business logic (co-located with entity definitions)
  - ‚úÖ EF Core + Npgsql with native JSONB support
  - ‚úÖ No runtime DI - static initialization via `CoreService.InitializeServices()`
  - ‚úÖ Source generators (DbContext, EntityConfig, DatabaseService accessors, Archive entities)
  - ‚úÖ Event bus system (CoreEventBus, DiscBotEventBus, GlobalEventBus with forwarding)
  - ‚úÖ Partial class architecture (generator-friendly with manual extensions)
- **Performance Verification**:
  - ‚úÖ JSONB operations via Npgsql dynamic JSON
  - ‚úÖ GIN indexes for JSONB containment queries
  - ‚úÖ Pluggable caching (NoOp, InMemory LRU)
  - ‚úÖ Connection pooling via NpgsqlDataSource
  - ‚è≥ Performance baselines documented
- **Code Quality Verification**:
  - ‚úÖ Entity + EntityCore separation of concerns
  - ‚úÖ Consistent patterns across all entities
  - ‚úÖ [EntityMetadata] attribute-driven configuration
  - ‚úÖ Proper error handling via ErrorService
  - ‚è≥ Deprecated code cleanup

### Success Metrics
- ‚ö™ All tests pass (unit ‚úÖ, integration ‚è≥, performance ‚è≥)
- ‚ö™ Zero breaking changes (no production deployments yet)
- ‚ö™ Performance baselines established ‚è≥
- ‚úÖ Code maintainable (Entity + EntityCore pattern, source generation)
- ‚è≥ Documentation complete (refactoring logs ‚úÖ, user guides ‚è≥)
- ‚è≥ Clean architecture (deprecated directory cleanup pending)
